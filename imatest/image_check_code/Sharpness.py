import cv2
import numpy as np
import os

# --- Sam å½±åƒå“è³ªåŸºç¤åˆ†æå·¥å…· (Sam Image Quality Base Analyzer) ---

def calculate_laplacian_variance(image_path):
    """
    è¨ˆç®—å½±åƒçš„ Laplacian è®Šç•°æ•¸ä½œç‚ºéŠ³åˆ©åº¦ (Sharpness) çš„åŸºç¤ä¼°è¨ˆã€‚
    æ•¸å€¼è¶Šé«˜ï¼Œå½±åƒé€šå¸¸è¶ŠéŠ³åˆ© (ä½†æ˜“å—å™ªè²å½±éŸ¿)ã€‚
    
    Args:
        image_path (str): è¼¸å…¥å½±åƒçš„è·¯å¾‘ã€‚
        
    Returns:
        float: å½±åƒçš„ Laplacian è®Šç•°æ•¸ã€‚
    """
    if not os.path.exists(image_path):
        print(f"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆè·¯å¾‘ {image_path}")
        return 0.0

    # 1. è®€å–å½±åƒ (ä»¥ç°åº¦æ¨¡å¼è®€å–ä»¥ç°¡åŒ–è™•ç†)
    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)

    if img is None:
        print(f"éŒ¯èª¤: ç„¡æ³•è®€å–å½±åƒ {image_path}")
        return 0.0

    # 2. è¨ˆç®— Laplacian 
    # Laplacian é‹ç®—å­ç”¨æ–¼è¨ˆç®—å½±åƒçš„äºŒéšå°æ•¸ï¼Œå¸¸ç”¨æ–¼é‚Šç·£æª¢æ¸¬ã€‚
    # cv2.CV_64F: ç¢ºä¿è¨ˆç®—ç²¾åº¦ï¼Œé¿å…æº¢ä½
    laplacian = cv2.Laplacian(img, cv2.CV_64F)

    # 3. è¨ˆç®— Laplacian è®Šç•°æ•¸
    # è®Šç•°æ•¸ä»£è¡¨äº†å½±åƒä¸­ç°åº¦è®ŠåŒ–çš„ç¨‹åº¦ï¼Œå¯ç”¨ä¾†è¡¡é‡éŠ³åˆ©åº¦ã€‚
    variance = laplacian.var()
    
    return variance

# ----------------- å½±åƒå“è³ªå…¨é¢åˆ†æä¸»å‡½æ•¸ -----------------

def image_quality_analysis(image_path):
    """
    å½±åƒå“è³ªåˆ†æçš„ä¸»å‡½æ•¸ï¼Œæä¾›åŸºç¤çš„éŠ³åˆ©åº¦åˆ†æå’Œå¯æ“´å±•çš„åˆ†ææ¶æ§‹ã€‚
    
    Args:
        image_path (str): è¼¸å…¥å½±åƒçš„è·¯å¾‘ã€‚
    """
    print(f"--- é–‹å§‹åˆ†æå½±åƒ: {os.path.basename(image_path)} ---")

    # === åŸºç¤éŠ³åˆ©åº¦åˆ†æ (Sharpness Estimation) ===
    lap_var = calculate_laplacian_variance(image_path)
    print(f"** åŸºç¤éŠ³åˆ©åº¦ (Laplacian Variance): {lap_var:.2f}")

    # ==========================================================
    # === é ç•™åŠŸèƒ½æ“´å±•å€ (Future Expansion Area) ===
    # ==========================================================
    
    # é ç•™ 1: å™ªè²åˆ†æ (Noise Analysis)
    # å¦‚éœ€æ–°å¢å™ªè²åˆ†æåŠŸèƒ½ (ä¾‹å¦‚æ¨™æº–å·®æˆ– Wiener æ¿¾æ³¢åˆ†æ)ï¼Œè«‹è§£é™¤è¨»é‡‹ä¸¦å¡«å…¥ç¨‹å¼ç¢¼ã€‚
    # print("\n[åŠŸèƒ½å±è”½]: å™ªè²å’Œ SNR åˆ†æ...")
    # try:
    #     img = cv2.imread(image_path)
    #     if img is not None:
    #         # é€™è£¡å¯ä»¥åŠ å…¥è¨ˆç®—å½±åƒæ¨™æº–å·®æˆ–å…¶ä»–å™ªè²æŒ‡æ¨™çš„ç¨‹å¼ç¢¼
    #         pass
    # except Exception as e:
    #     print(f"å™ªè²åˆ†æå¤±æ•—: {e}")
    
    # é ç•™ 2: é¡è‰²æº–ç¢ºåº¦åˆ†æ (Color Accuracy)
    # å¦‚éœ€æ–°å¢é¡è‰²åˆ†æåŠŸèƒ½ (ä¾‹å¦‚åˆ†æè‰²å½©ç©ºé–“æˆ–è‰²å·® $\Delta E$)ï¼Œè«‹è§£é™¤è¨»é‡‹ä¸¦å¡«å…¥ç¨‹å¼ç¢¼ã€‚
    # **æ³¨æ„:** çœŸæ­£çš„è‰²å½©æº–ç¢ºåº¦åˆ†æé€šå¸¸éœ€è¦æ¨™æº–è‰²å¡ä½œç‚ºåƒè€ƒã€‚
    # print("\n[åŠŸèƒ½å±è”½]: é¡è‰²æº–ç¢ºåº¦åˆ†æ...")
    # try:
    #     # é€™è£¡å¯ä»¥åŠ å…¥è¨ˆç®—è‰²å½©æº–ç¢ºåº¦ï¼ˆéœ€é…åˆæ¨™æº–è‰²å¡Šï¼‰çš„ç¨‹å¼ç¢¼
    #     pass
    # except Exception as e:
    #     print(f"é¡è‰²åˆ†æå¤±æ•—: {e}")
        
    # é ç•™ 3: ç•¸è®Šæ ¡æ­£/åˆ†æ (Distortion Analysis/Correction)
    # å¦‚éœ€åŠ å…¥é¡é ­ç•¸è®Šåˆ†ææˆ–æ ¡æ­£åŠŸèƒ½ï¼Œè«‹è§£é™¤è¨»é‡‹ä¸¦å¡«å…¥ç¨‹å¼ç¢¼ (éœ€æœ‰é¡é ­åƒæ•¸çŸ©é™£)ã€‚
    # print("\n[åŠŸèƒ½å±è”½]: é¡é ­ç•¸è®Šåˆ†æèˆ‡æ ¡æ­£...")
    # try:
    #     # é€™è£¡å¯ä»¥åŠ å…¥è®€å–ç›¸æ©Ÿæ ¡æ­£åƒæ•¸ä¸¦é€²è¡Œç•¸è®Šæ ¡æ­£çš„ç¨‹å¼ç¢¼
    #     pass 
    # except Exception as e:
    #     print(f"ç•¸è®Šåˆ†æå¤±æ•—: {e}")

    print("\n--- å½±åƒåˆ†æå®Œæˆ (æœªä¾†åŠŸèƒ½å·²é ç•™) ---")

# ==========================================================
# === ç¨‹å¼åŸ·è¡Œç¯„ä¾‹ (è«‹æ›¿æ›ç‚ºæ‚¨çš„å½±åƒè·¯å¾‘) ===
# ==========================================================

# âš ï¸ è«‹å°‡ 'test_image.jpg' æ›¿æ›ç‚ºæ‚¨å¯¦éš›çš„å½±åƒæª”æ¡ˆè·¯å¾‘
# ç¢ºä¿è©²å½±åƒæª”æ¡ˆåœ¨ç¨‹å¼ç¢¼å¯å­˜å–çš„è·¯å¾‘ä¸‹ï¼Œæˆ–ä½¿ç”¨å®Œæ•´çš„çµ•å°è·¯å¾‘ã€‚
if __name__ == '__main__':
    # å‡è¨­é€™æ˜¯æ‚¨è¦æ¸¬è©¦çš„å½±åƒè·¯å¾‘
    test_image_path = 'sample_image.jpg' 
    
    # ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹å­˜åœ¨çš„æª”æ¡ˆè·¯å¾‘ã€‚
    # ç”±æ–¼æˆ‘ç„¡æ³•å­˜å–æ‚¨çš„æœ¬åœ°æª”æ¡ˆç³»çµ±ï¼Œè«‹æ‚¨è‡ªè¡Œæ›¿æ›ä¸€å€‹å­˜åœ¨çš„å½±åƒæª”æ¡ˆè·¯å¾‘ã€‚
    
    # ğŸ“¢ æ³¨æ„: é‹è¡Œå‰è«‹ç¢ºä¿æ‚¨çš„ç’°å¢ƒå·²å®‰è£ OpenCV (pip install opencv-python)
    
    # åŸ·è¡Œå½±åƒåˆ†æ
    # image_quality_analysis(test_image_path)
    
    # ç”±æ–¼ç„¡æ³•å­˜å–æœ¬åœ°æª”æ¡ˆï¼Œé€™è£¡åƒ…å°å‡ºä½¿ç”¨æç¤º
    print(f"\n[åŸ·è¡Œæç¤º]: è«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ 'sample_image.jpg' æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å½±åƒè·¯å¾‘ï¼Œä¸¦å–æ¶ˆä¸»å‡½æ•¸èª¿ç”¨éƒ¨åˆ†çš„è¨»é‡‹ä¾†åŸ·è¡Œç¨‹å¼ã€‚")