# ccm_test_3.py - 手動圖片模式使用指南

## 新增功能

### 1. 菜單栏 (Menu Bar)
- **File 菜單**：
  - **Open Image (JPEG/PNG/BMP)**：打開自訂圖片
  - **Exit**：退出程序

### 2. 打開圖片功能
- 支持格式：JPEG、PNG、BMP
- 自動縮放圖片以適應顯示區域
- 自動檢測24色塊位置

### 3. 自動色塊檢測
- 使用 K-means 聚類算法
- 自動生成24個色塊方框
- 按位置排序（從左到右，從上到下）

### 4. 手動方框調整

#### 選擇方框
- **點擊**任何方框即可選中（邊框變紅色，線寬變粗）

#### 移動方框
- 選中方框後，**點擊並拖拽**即可移動
- 方框會跟隨滑鼠移動

#### 調整方框大小
- 選中方框後，按住 **Shift 鍵**並拖拽滑鼠
- 向右/下拖拽增大，向左/上拖拽縮小

### 5. 實時 Lab 值更新
- 每次調整方框時，系統會：
  1. 提取方框内的平均顏色
  2. 將顏色轉換為 Lab 色彩空間
  3. 自動更新「24 色色彩卡 Lab 值分析」窗口

## 使用流程

### 基本流程
1. 運行 `ccm_test_3.py`
2. 默認加載 24 色標準色卡
3. 點擊菜單 **File → Open Image**
4. 選擇圖片文件（JPEG/PNG/BMP）
5. 圖片加載並自動檢測24色塊
6. 根據需要調整方框位置和大小
7. 在 Lab 分析窗口中查看實時數據

### 進階操作

#### 精細調整
- 選中方框後逐像素移動和調整大小
- 每次拖拽後立即更新 Lab 顯示

#### 切換回標準色卡
- 重新打開程序可恢復標準24色卡模式
- 或在代碼中設置不同的初始圖片

## 技術細節

### 色塊檢測算法
```
1. 將影像轉換為像素列表
2. 使用 cv2.kmeans 進行 K-means 聚類
3. 設置聚類數為 24
4. 計算每個聚類的邊界框
5. 按 (y, x) 座標排序
```

### 色塊信息存儲
```python
box_positions = [
    {
        'x': x座標,
        'y': y座標,
        'width': 寬度,
        'height': 高度,
        'index': 方框索引
    },
    ...
]
```

### 顏色提取
- 從每個方框內提取所有像素
- 計算像素的平均 RGB 值
- 轉換為 Lab 色彩空間

### 鼠標交互機制
- **button_press_event**：記錄起始點
- **motion_notify_event**：根據 Shift 鍵判斷操作（移動/調整大小）
- **button_release_event**：結束操作

## 視覺反饋

| 狀態 | 邊框顏色 | 線寬 | 說明 |
|------|---------|------|------|
| 未選中 | 青色 (Cyan) | 2 | 初始狀態 |
| 已選中 | 紅色 (Red) | 3 | 可進行操作 |

## Lab 值分析窗口更新

### 手動模式信息
```
【色塊 #1】色塊名稱
  L*: 值  a*: 值  b*: 值  ΔE: 值  ΔC: 值  Sat: 值
```

### 參數解釋
- **L***：亮度 (0-100)
- **a***：紅-綠軸 (-128 ~ 127)
- **b***：黃-藍軸 (-128 ~ 127)
- **ΔE**：色差
- **ΔC**：色度差
- **Sat**：飽和度 (0-255)

## 常見問題

### Q：色塊檢測不准確
A：自動檢測基於圖片的顏色分佈。如果圖片顏色不夠清晰，可手動調整方框。

### Q：方框超出影像邊界
A：系統會自動限制方框在影像範圍內，提取時會自動裁剪。

### Q：切換回標準色卡
A：重新運行程序即可恢復初始的24色標準色卡。

### Q：如何微調方框
A：使用小幅度拖拽即可精確調整，或按 Shift 鍵結合拖拽調整大小。

## 性能注意事項

- 自動檢測需要數秒時間（取決於圖片分辨率）
- 每次拖拽時會重新計算 Lab 值（實時更新）
- 建議圖片分辨率不超過 2000×2000 像素

## 快捷鍵總結

| 操作 | 說明 |
|------|------|
| 點擊方框 | 選中方框 |
| 拖拽 | 移動選中方框 |
| Shift + 拖拽 | 調整選中方框大小 |
| File → Open Image | 打開新圖片 |
| File → Exit | 退出程序 |
